<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>自习时长累计统计系统（校区版）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif; }
        .container { width: 80%; max-width: 1000px; margin: 20px auto; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        h1, h2 { text-align: center; margin-bottom: 20px; color: #333; }
        .sign-section { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; margin: 30px 0; }
        .input-group { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #666; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .btn-group { flex: 1; min-width: 200px; text-align: center; }
        button { padding: 10px 25px; margin: 0 5px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #3182ce; }
        .end-btn { background: #e53e3e; }
        .end-btn:hover { background: #c53030; }
        .timer-section { text-align: center; margin: 30px 0; }
        .timer { font-size: 40px; font-weight: bold; color: #4299e1; margin: 10px 0; }
        .record-section { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: center; border: 1px solid #ddd; }
        th { background: #f5f5f5; font-weight: bold; color: #333; }
        .rank-1 { background: #fff3cd; }
        .rank-2 { background: #e2e3e5; }
        .rank-3 { background: #ffeeba; }
        .admin-btn { text-align: center; margin: 20px 0; }
        .clear-btn { background: #e53e3e; }
        .clear-btn:hover { background: #c53030; }
    </style>
</head>
<body>
    <div class="container">
        <h1>自习时长累计统计系统（校区版）</h1>

        <!-- 手动签到区（取消定位，新增校区输入） -->
        <div class="sign-section">
            <div class="input-group">
                <label for="studentName">学生姓名</label>
                <input type="text" id="studentName" placeholder="请输入学生姓名" required>
            </div>
            <div class="input-group">
                <label for="studentCampus">所属校区</label>
                <input type="text" id="studentCampus" placeholder="如：主校区、南校区、北校区" required>
            </div>
            <div class="btn-group">
                <button id="startSignBtn">开始自习</button>
                <button id="endSignBtn" class="end-btn" disabled>结束自习</button>
            </div>
        </div>

        <!-- 计时显示区 -->
        <div class="timer-section">
            <h2>当前自习时长</h2>
            <div class="timer" id="timer">00:00:00</div>
        </div>

        <!-- 管理员操作区 -->
        <div class="admin-btn">
            <button id="refreshBtn">刷新时长排名</button>
            <button id="clearBtn" class="clear-btn" style="margin-left: 10px;">清空所有记录（谨慎）</button>
        </div>

        <!-- 时长排名表格 -->
        <div class="record-section">
            <h2>自习时长累计排名</h2>
            <table>
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>姓名</th>
                        <th>所属校区</th>
                        <th>今日时长（小时）</th>
                        <th>累计总时长（小时）</th>
                        <th>最后自习时间</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody id="recordTable">
                    <tr><td colspan="7">暂无自习记录</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 存储学生数据（本地缓存，刷新不丢失）
        let studentData = JSON.parse(localStorage.getItem('studyRecord')) || [];
        let currentStudent = null; // 当前自习学生
        let timerInterval = null; // 计时定时器

        // DOM元素
        const studentName = document.getElementById('studentName');
        const studentCampus = document.getElementById('studentCampus');
        const startSignBtn = document.getElementById('startSignBtn');
        const endSignBtn = document.getElementById('endSignBtn');
        const timer = document.getElementById('timer');
        const recordTable = document.getElementById('recordTable');
        const refreshBtn = document.getElementById('refreshBtn');
        const clearBtn = document.getElementById('clearBtn');

        // 初始化：加载历史记录
        window.onload = renderRecordTable;

        // 1. 开始自习签到
        startSignBtn.addEventListener('click', () => {
            const name = studentName.value.trim();
            const campus = studentCampus.value.trim();

            // 校验输入
            if (!name || !campus) {
                alert('请输入姓名和所属校区！');
                return;
            }

            // 检查是否已在自习
            const isStudying = studentData.some(s => s.name === name && s.campus === campus && s.isStudying);
            if (isStudying) {
                alert(`【${name}（${campus}）】已在自习中，无需重复签到！`);
                return;
            }

            // 记录当前学生信息
            currentStudent = {
                name,
                campus,
                startTime: new Date().getTime(),
                isStudying: true
            };

            // 更新学生数据
            const studentIndex = studentData.findIndex(s => s.name === name && s.campus === campus);
            if (studentIndex > -1) {
                studentData[studentIndex].isStudying = true;
                studentData[studentIndex].startTime = currentStudent.startTime;
            } else {
                studentData.push({
                    name,
                    campus,
                    todayHour: '0.00',
                    totalHour: '0.00',
                    lastStudyTime: '-',
                    isStudying: true,
                    startTime: currentStudent.startTime
                });
            }

            // 保存数据 + 启动计时
            localStorage.setItem('studyRecord', JSON.stringify(studentData));
            timerInterval = setInterval(updateTimer, 1000);
            alert(`【${name}（${campus}）】签到成功，开始计时！`);

            // 按钮状态切换
            startSignBtn.disabled = true;
            endSignBtn.disabled = false;
            studentName.disabled = true;
            studentCampus.disabled = true;
        });

        // 2. 结束自习签退
        endSignBtn.addEventListener('click', () => {
            if (!currentStudent) {
                alert('尚未开始自习，无需签退！');
                return;
            }

            // 计算自习时长（毫秒转小时，保留2位小数）
            const endTime = new Date().getTime();
            const durationMs = endTime - currentStudent.startTime;
            const durationHour = (durationMs / 3600000).toFixed(2);
            const lastStudyTime = new Date(endTime).toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            // 更新学生数据
            const studentIndex = studentData.findIndex(s => s.name === currentStudent.name && s.campus === currentStudent.campus);
            if (studentIndex > -1) {
                const oldTotal = parseFloat(studentData[studentIndex].totalHour);
                studentData[studentIndex] = {
                    ...studentData[studentIndex],
                    todayHour: durationHour,
                    totalHour: (oldTotal + parseFloat(durationHour)).toFixed(2),
                    lastStudyTime,
                    isStudying: false,
                    startTime: null
                };
            }

            // 保存数据 + 停止计时
            localStorage.setItem('studyRecord', JSON.stringify(studentData));
            clearInterval(timerInterval);
            alert(`【${currentStudent.name}（${currentStudent.campus}）】自习结束，本次时长：${durationHour}小时！`);

            // 重置状态
            timer.textContent = '00:00:00';
            currentStudent = null;
            startSignBtn.disabled = false;
            endSignBtn.disabled = true;
            studentName.disabled = false;
            studentCampus.disabled = false;
            studentName.value = '';
            studentCampus.value = '';

            // 刷新排名表格
            renderRecordTable();
        });

        // 3. 管理员操作：刷新排名、清空记录
        refreshBtn.addEventListener('click', renderRecordTable);
        clearBtn.addEventListener('click', () => {
            if (confirm('确定要清空所有记录吗？此操作不可恢复！')) {
                studentData = [];
                localStorage.removeItem('studyRecord');
                renderRecordTable();
                alert('所有记录已清空！');
            }
        });

        // 辅助函数：更新计时显示
        function updateTimer() {
            if (!currentStudent) return;
            const now = new Date().getTime();
            const durationMs = now - currentStudent.startTime;
            const hours = Math.floor(durationMs / 3600000).toString().padStart(2, '0');
            const minutes = Math.floor((durationMs % 3600000) / 60000).toString().padStart(2, '0');
            const seconds = Math.floor((durationMs % 60000) / 1000).toString().padStart(2, '0');
            timer.textContent = `${hours}:${minutes}:${seconds}`;
        }

        // 辅助函数：渲染排名表格
        function renderRecordTable() {
            // 按累计总时长降序排序
            studentData.sort((a, b) => parseFloat(b.totalHour) - parseFloat(a.totalHour));
            recordTable.innerHTML = '';

            // 无数据提示
            if (studentData.length === 0) {
                recordTable.innerHTML = '<tr><td colspan="7">暂无自习记录</td></tr>';
                return;
            }

            // 生成表格数据
            studentData.forEach((student, index) => {
                const tr = document.createElement('tr');
                // 前三名标色
                if (index === 0) tr.className = 'rank-1';
                if (index === 1) tr.className = 'rank-2';
                if (index === 2) tr.className = 'rank-3';

                // 实时计算正在自习学生的当前时长
                let currentDuration = student.todayHour;
                if (student.isStudying && student.startTime) {
                    const now = new Date().getTime();
                    currentDuration = ((now - student.startTime) / 3600000).toFixed(2);
                }

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.name}</td>
                    <td>${student.campus}</td>
                    <td>${currentDuration}</td>
                    <td>${student.totalHour}</td>
                    <td>${student.lastStudyTime}</td>
                    <td>${student.isStudying ? '<span style="color: #48bb78; font-weight: bold;">自习中</span>' : '已结束'}</td>
                `;
                recordTable.appendChild(tr);
            });
        }
    </script>
</body>
</html>
